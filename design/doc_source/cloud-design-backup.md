# バックアップ・リストア
## 要件、RTO/RPO/RLO

## システムバックアップ
### バックアップ方式
AMI または スナップショットでボリューム全体をバックアップ。  
オンラインで取得可能。  
静止点を取るにはシャットダウン、またはそれに近い状態で AMI/スナップショットを取得する。    

### リストア方式
#### EC2
1. バックアップ元の EC2 を停止する。
2. AMI から EC2 を復元する。
3. 復元後はタグや EIP を元の状態に戻す。

### 遠隔保管
バックアップのリージョン間複製は想定しない。  
DR 要件が新たに発生した際にリージョン間複製を検討する。  

## ボリュームバックアップ
### バックアップ方式
スナップショットで EBS ボリュームをバックアップ。   
RPO が短いデータが含まれているボリュームを対象とする。  
OS のシステム部分やアプリケーションインストールディレクトリとは切り離したデータのみのボリュームにしておく。  

### リストア方式
1. スナップショットから新しい EBS を作成する。
2. 対象の EC2 をシャットダウンする。
3. バックアップ元のボリュームをデタッチする。
4. 新しいボリュームをアタッチする。
5. EC2 の起動。

### 遠隔保管
バックアップのリージョン間複製は想定しない。  
DR 要件が新たに発生した際にリージョン間複製を検討する。  


## ファイルバックアップ
### バックアップ方式
法制度や条例、業界ルールなどで長期間の保管が義務付けられているファイルは S3 へ保管する。  
読み取りがほぼ発生しないファイルについては S3 Glacier を検討する。  

### リストア方式
S3 から該当のファイルのみを手動で取り出す。  

### 遠隔保管
バックアップのリージョン間複製は想定しない。  
DR 要件が新たに発生した際にリージョン間複製を検討する。  

## DBバックアップ
### バックアップ方式
#### RDBMS on EC2
RDBMS 製品ネイティブの機能を使ってダンプを出力する。  
ダンプを出力したボリュームに対してスナップショットでバックアップを行う。  

#### Aurora/RDS
バックアップウィンドウ期間中で自動的にバックアップが取得される。  

### リストア方式
#### RDBMS on EC2
「ボリュームバックアップ」を参照してボリュームをリストアする。  
リストアされたボリューム内のダンプをインポートする。  

#### Aurora/RDS
1. Aurora/RDS にアクセスするアプリケーションを停止する。
2. バックアップ元の Aurora/RDS のエンドポイントをリネームする。 (xx-old など)
3. 特定時点の復元から Aurora/RDS を復元する。
4. エンドポイントやレプリカなどの設定を復元する。

※ エンドポイントリネームの代わりに DNS CNAME レコードでの運用が考えられる。システムで DNS サーバーを持っている場合は DNS による管理を行う。    


### 遠隔保管
バックアップのリージョン間複製は想定しない。  
DR 要件が新たに発生した際にリージョン間複製を検討する。  

